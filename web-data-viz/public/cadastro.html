<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro | RemoteGuard</title>
    <link rel="stylesheet" href="css/login_cadastro.css">
    <link rel="icon" href="img/svg/aguia2.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body onload="listarEmpresas()">
    <div class="container">
        <div class="cadastre_esquerda">
            <img src="./assets/imgs/AguiaComOnome.png" alt="">
            <h1><b>Potencialize</b> a produtividade no trabalho remoto</h1>

            <button onclick="location.href='index.html'">Voltar ao Início</button>
        </div>
        <div class="cadastre">
            <div class="card">
                <div class="inputs">
                    <div class="titleCad">Cadastre-se</div>
                    <div class="input-grupo">
                        <div class="input-caixa">
                            <label for="input_nome">Nome:</label>
                            <div class="input-field" id="nome_field">
                                <i class="fa-solid fa-user"></i>
                                <input type="text" id="input_nome" placeholder="Insira seu nome">

                            </div>
                            <div id="nome-erro" class="mensagem-erro"></div>
                        </div>
                        <div class="input-caixa">
                            <label for="input_senha">Senha:</label>
                            <div class="input-field" id="senha_field">
                                <i class="fa-solid fa-lock"></i>
                                <input type="password" id="input_senha" placeholder="Insira sua Senha">
                                <i class="fa-solid fa-eye" id="showPassword" onclick="showPassword()"></i>
                            </div>
                            <div id="senha-erro" class="mensagem-erro"></div>
                        </div>

                    </div>

                    <div class="input-caixa">
                        <label for="inpu_email">E-mail:</label>
                        <div class="input-field-email" id="email_field">
                            <i class="fa-solid fa-envelope"></i>
                            <input type="text" id="input_email" placeholder="Insira seu E-mail">
                        </div>
                        <div id="email-erro" class="mensagem-erro"></div>
                    </div>
                    <div class="input-grupo">
                        <div class="input-caixa">
                            <label for="inpu_cpf">CPF:</label>
                            <div class="input-field" id="cpf_field">
                                <i class="fas fa-id-card"></i>
                                <input type="text" id="input_cpf" placeholder="Insira seu CPF">
                            </div>
                            <div id="CPF-erro" class="mensagem-erro"></div>
                        </div>
                        <div class="input-caixa">
                            <label for="select_funcao">Cargo:</label>
                            <div class="input-field_cargo" id="funcao_field">
                                <i class="fas fa-user-tie"></i>
                                <select id="input_cargo" disabled>
                                    <option value="#">Selecione seu Cargo</option>
                                    <option value="gerente" selected>Gerente</option>
                                    <option value="analista" disabled>Analista</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="input-grupo">
                        <div class="input-caixa">
                            <label for="select_empresa">Empresa:</label>
                            <div class="input-field" id="empresa_field">
                                <i class="fas fa-building"></i>
                                <select id="input_empresa" class="select-empresa">
                                    <option selected disabled value="#">Selecione a Empresa</option>

                                </select>
                            </div>
                            <div id="empresa-erro" class="mensagem-erro"></div>
                        </div>

                        <div class="input-caixa">
                            <label for="input_token">Token:</label>
                            <div class="input-field" id="Token">
                                <i class="fa-solid fa-key"></i>
                                <input type="text" id="input_token" placeholder="Insira o token">
                            </div>
                            <div id="token-erro" class="mensagem-erro"></div>
                        </div>
                    </div>
                </div>
                <button onclick="cadastrar()">Cadastrar</button>
                <span class="possui_cadastro">Já possui Cadastro? <a href="login.html" class="possui_cadastro_a">
                        Fazer Login</a></span>
            </div>
        </div>
    </div>
</body>

</html>
<script>

    var requisicaoPadrao = '';
    var empresas = [];
    var tokens = [];
    var id= [];

    function listarEmpresas() {
        fetch("/empresas/listar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ requisicaoPadraoServer: requisicaoPadrao })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(json => {
                    const selectEmpresa = document.getElementById("input_empresa");
                    json.resultado.forEach(empresa => {
                        const option = document.createElement("option");
                        option.value = empresa.idEmpresa; // ou outro identificador
                        option.textContent = empresa.nomeFantasia;
                        selectEmpresa.appendChild(option);
                    });
                });
            } else {
                throw "Erro ao listar empresas!";
            }
        }).catch(function (erro) {
            console.log(`#ERRO: ${erro}`);
        });
    }

    function listar() {
        fetch("/empresas/listar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                requisicaoPadraoServer: requisicaoPadrao
            })
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));
                    console.log(json.resultado[0].idEmpresa)
                    for (var cont = 0; cont <= json.resultado.length - 1; cont++) {
                        var empresa = json.resultado[cont];
                        empresas.push(empresa.nomeFantasia)
                        tokens.push(empresa.token)
                        id.push(empresa.idEmpresa)
                    }
                });
                finalizarAguardar();

            } else {
                throw "Houve um erro ao tentar realizar o cadastro!";
            }
        })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });

        return false;
    }

    function cadastrar() {
        var nomeVar = input_nome.value;
        var emailVar = input_email.value;
        var senhaVar = input_senha.value;
        var cargoVar = input_cargo.value;
        var nomeEmpresaVar = input_empresa.value;
        var cpfVar = input_cpf.value;
        var tokenVar = input_token.value;

        var caixaBaixaEmail = emailVar.toLowerCase();
        var caixaBaixaEmpresa = nomeEmpresaVar.toLowerCase();

        var tamanhoSenha = senhaVar.length;

        var cpfTamanho = cpfVar.length;
        var senhaTamanho = senhaVar.length;

        var indiceArrobaSenha = senhaVar.indexOf('@');
        var indiceHashtagSenha = senhaVar.indexOf('#');
        var indiceCifraoSenha = senhaVar.indexOf('$');
        var indiceComercialSenha = senhaVar.indexOf('&');

        var indiceArrobaEmail = emailVar.indexOf('@');
        var indicePontoEmail = emailVar.indexOf('.');

        var fazerCadastro = true;
        var metricaContador = 0;

        for (var cont = 0; cont <= empresas.length - 1; cont++) {
            if (nomeEmpresaVar == id[cont]){
                metricaContador = cont
                console.log("if 1")
            }  
            }
            if (tokenVar != tokens[metricaContador]){
                fazerCadastro = false;
                console.log("erro no token")
            }
    
        if (nomeVar == "" ||
            emailVar == "" ||
            senhaVar == "" ||
            cargoVar == "" ||
            nomeEmpresaVar == 0 ||
            cpfVar == ""
        ) {
            // div_mensagem.innerHTML =
            //     `<span style="color: yellow;"> - Todos os campos devem estar preenchidos!</span><br><br>`;
            fazerCadastro = false;
            return false;
            console.log("campos em branco")
        }

        if (indiceArrobaSenha < 0 &&
            indiceCifraoSenha < 0 &&
            indiceComercialSenha < 0 &&
            indiceHashtagSenha < 0
        ) {
            // div_mensagem.innerHTML =
            //     `<span style="color: yellow;"> - Senha inválida, tente novamente! (a senha precisa ter pelo menos 1 caractere especial entre essas opções: (@ - # - $ - &))</span><br><br>`;
            fazerCadastro = false;
            return false;
            console.log("senha zerada")
        }

        if (cpfTamanho != 11
        ) {
            // div_mensagem.innerHTML =
            //     `<span style="color: yellow;"> - CPF inválido, tente novamente! (quantidade de dígitos errada)</span><br><br>`;
            fazerCadastro = false;
            return false;
            console.log("cpf torto")
        }

        if (tamanhoSenha < 5 ||
            tamanhoSenha > 15
        ) {
            // div_mensagem.innerHTML =
            //     `<span style="color: yellow;"> - Senha inválida, tente novamente! (a senha precisa ter pelo menos 5 caracteres e no máximo 15 caracteres)</span><br><br>`;
            fazerCadastro = false;
            return false;
            console.log("senha com mais ou mneos caracteres")
        }

        if (indiceArrobaEmail < 0 ||
            indicePontoEmail < 0
        ) {
            // div_mensagem.innerHTML =
            //     `<span style="color: yellow;"> - Email inválido, tente novamente! (o email precisa ter "@" e ".")</span><br><br>`;
            fazerCadastro = false;
            return false;
            console.log("email sem arroba")
        }
        
        if (fazerCadastro) {
            fetch("/usuarios/cadastrar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    nomeServer: nomeVar,
                    emailServer: emailVar,
                    senhaServer: senhaVar,
                    empresaServer: nomeEmpresaVar,
                    cargoServer: cargoVar,
                    cpfServer: cpfVar
                }),
            })
                .then(function (resposta) {
                    console.log(`Resposta da requisição: ${JSON.stringify(resposta)}`);
                    if (resposta.ok) {
                        alert("Cadastro feito com sucesso");
                        resposta.json().then(json => {
                            console.log(JSON.stringify(json));
                        });

                        setTimeout(() => {              
                           window.location.href = "./login.html"
                        }, 1000);
                    } else {
                        resposta.json().then(json => {
                            console.log(JSON.stringify(json));
                            // O método includes busca uma substring dentro de um string, ou seja, se o SQL retornar a mensagem "Duplicate entry" ele entra no if
                            if (JSON.stringify(json).includes("Duplicate entry")) {
                                alert("O email utilizado já existe no sistema");
                            }
                        });
                        // alert('Não foi possível cadastrar o usuário');
                        console.log("Houve um erro ao tentar realizar o login!");
                    }
                }).catch(function (erro) {
                    console.log(erro);
                })
        }

    }

    let menu = document.querySelector('#divLinksLogin');

    function showMain() {
        menu.style.display = 'flex';
        clearTimeout(tempo_espera);
    }
    function hiddeMain() {
        tempo_espera = setTimeout(function () {
            menu.style.display = 'none';
        }, 1000);
    }

    window.onload = function () {
        listarEmpresas();
        listar(); // Chama a função existente se necessário
    };



</script>