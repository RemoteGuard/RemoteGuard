<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/css-renan.css">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="trazerProcessos(), trazerDados(), plotarGrafico()">
    <div class="processosEfuncionarios">
        <div class="div_processos">
            <h2>Processos mais utilizados</h2>
            <div id="div_alerta"></div>
        </div>
        <div class="div_funcionarios">
            <span>Funcionarios com os computadores em PERIGO: (utilização maior que 90%)</span>
            <div id="div_card_perigo"></div>
            <span>Funcionarios com os computadores em ALERTA: (utilização maior que 95%)</span>
            <div id="div_card_urgencia"></div>
            <span>Funcionarios em possivel inatividade: (utilização menor que 30%)</span>
            <a href="">
                <div id="div_card_inatividade">
            </a>
        </div>
    </div>
    </div>

    <canvas id="myChart" width="100" height="40"></canvas>
</body>
<script>
    const requisicaoPadrao = "";
    function trazerProcessos() {
        let qtdProcessos = []
        var nomeFuncionarios = []
        let porcentagensCpu = []
        let porcentagensRam = []
        let vetorProcessos = []
        let contagemOrdenada;
        let contagem;
        let vetorProcessosTeste = []

        fetch("/renan/processos", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                requisicaoPadraoServer: requisicaoPadrao
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(json => {
                    json.resultado.forEach(processo => {
                        var processosReplaceBarraInversa = processo.processos.replaceAll(']', '')
                        var processosReplaceBarraComum = processosReplaceBarraInversa.replaceAll('[', '')
                        var processosReplaceEspaco = processosReplaceBarraComum.replaceAll(' ', '')
                        processosSeparados = processosReplaceEspaco.split(",")
                        for (var i = 0; i < processosSeparados.length; i++) {
                            vetorProcessos.push(processosSeparados[i])
                        }
                    });
                    contagem = vetorProcessos.reduce((acc, processo) => {
                        acc[processo] = (acc[processo] || 0) + 1;
                        return acc;
                    }, {})
                    var jsonContagem = contagem
                    var contagemOrdenada = Object.entries(contagem).sort((a, b) => b[1] - a[1]).map((v) => ({ nome: v[0], qtd: v[1] }))
                    var processosMaisUtilizadosNome = []
                    var processosMaisUtilizadosQtd = []
                    for (var i = 0; i < 6; i++) {
                        processosMaisUtilizadosNome.push(contagemOrdenada[i].nome)
                        processosMaisUtilizadosQtd.push(contagemOrdenada[i].qtd)
                    }
                    div_alerta.innerHTML = ''
                    for (var i = 0; i < processosMaisUtilizadosNome.length; i++) {
                        div_alerta.innerHTML += processosMaisUtilizadosNome[i] + " total: " + processosMaisUtilizadosQtd[i] + "<br>"
                    }
                    setTimeout(trazerProcessos, 2000)


                });
            } else {
                throw "Erro ao trazer processos!";
            }
        }).catch(function (erro) {
            console.log(`#ERRO: ${erro}`);
        });
    }
    function trazerDados() {
        let vetorUrgencia = []
        let vetorPerigo = []
        let vetorInatividade = []
        fetch("/renan/ultimosDados", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ requisicaoPadraoServer: requisicaoPadrao })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(json => {
                    for (var i = 0; i < json.resultado.length; i++) {
                        if (json.resultado[i].porcentagem_cpu >= 90 || json.resultado[i].porcentagem_ram >= 90) {
                            if (json.resultado[i].porcentagem_cpu < 95 && json.resultado[i].porcentagem_ram < 95) {
                                vetorPerigo.push(json.resultado[i].nome)
                            }
                        }
                        if (json.resultado[i].porcentagem_cpu >= 95 || json.resultado[i].porcentagem_ram >= 95) {
                            vetorUrgencia.push(json.resultado[i].nome)
                        }
                        if (json.resultado[i].porcentagem_cpu < 30 && json.resultado[i].porcentagem_ram < 30) {
                            vetorInatividade.push(json.resultado[i].nome)
                        }
                    }

                    const perigoContainer = document.getElementById('div_card_perigo');
                    const urgenciaContainer = document.getElementById('div_card_urgencia');
                    const inatividadeContainer = document.getElementById('div_card_inatividade');

                    inatividadeContainer.innerHTML = '';
                    urgenciaContainer.innerHTML = '';
                    perigoContainer.innerHTML = '';


                    function adicionarNomesAoCard(container, nomes) {
                        nomes.forEach(nome => {
                            const card = document.createElement('div');
                            card.classList.add('card');
                            card.textContent = nome;

                            // Adiciona evento de clique para redirecionar
                            card.addEventListener('click', () => {
                               var nomeUsuario = nome

                                fetch("/renan/chamarIdNotebook", {

                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify({
                                         nomeFuncionario : nomeUsuario
                                        })
                                }).then(function (resposta) {
                                    if (resposta.ok) {
                                        resposta.json().then(json => {
                                        let idNotebook = json.resultado[0].idNotebook
                                        sessionStorage.setItem('ID_NOTEBOOK', idNotebook);  
                                        });
                                    } else {
                                        throw "Erro ao plotar grafico!";
                                    }
                                }).catch(function (erro) {
                                    console.log(`#ERRO: ${erro}`);
                                });
                               window.location.href = "DashAnalista.html";
                            });

                            container.appendChild(card);
                        });
                    }


                    adicionarNomesAoCard(inatividadeContainer, vetorInatividade);
                    adicionarNomesAoCard(urgenciaContainer, vetorUrgencia);
                    adicionarNomesAoCard(perigoContainer, vetorPerigo);
                    setTimeout(trazerDados, 2000)

                });
            } else {
                throw "Erro ao trazer dados!";
            }
        }).catch(function (erro) {
            console.log(`#ERRO: ${erro}`);
        });
    }

    function plotarGrafico() {
        fetch("/renan/plotarGrafico", {

            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ requisicaoPadraoServer: requisicaoPadrao })
        }).then(function (resposta) {
            if (resposta.ok) {
                let nomeFuncionariosMetrica = []
                let porcentagensCpuMetrica = []
                let porcentagensRamMetrica = []
                let qtdProcessosMetrica = []
                resposta.json().then(json => {
                    for (var i = 0; i < json.resultado.length; i++) {
                        nomeFuncionariosMetrica.push(json.resultado[i].nome)
                        porcentagensCpuMetrica.push(json.resultado[i].porcentagem_cpu)
                        porcentagensRamMetrica.push(json.resultado[i].porcentagem_ram)
                    }
                    for (var i = 0; i < json.resultado.length; i++) {
                        var metricaProcessos = 0;
                        for (var j = 0; j < json.resultado[i].processos.length; j++) {
                            metricaProcessos++
                        }
                        qtdProcessosMetrica.push(metricaProcessos)
                    }
                    nomeFuncionarios = nomeFuncionariosMetrica
                    porcentagensRam = porcentagensRamMetrica
                    porcentagensCpu = porcentagensCpuMetrica
                    qtdProcessos = qtdProcessosMetrica

                    carregarGrafico()
                    setTimeout(plotarGrafico, 10000)

                });
            } else {
                throw "Erro ao plotar grafico!";
            }
        }).catch(function (erro) {
            console.log(`#ERRO: ${erro}`);
        });
    }

    let myChart;
    function carregarGrafico() {
        const funcionarios = [...new Set(nomeFuncionarios)];

        // Geração inicial dos datasets
        const datasets = nomeFuncionarios.map((funcionario, index) => ({
            label: ` ${funcionario}`,
            data: [
                {
                    x: porcentagensCpu[index],
                    y: porcentagensRam[index],
                    r: qtdProcessos[index] / 150,
                },
            ],
            backgroundColor: "rgba(40, 168, 83, 0.3)",
        }));

        const data = {
            datasets: datasets,
        };

        const config = {
            type: "bubble",
            data: data,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: "top",
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                var nomeFuncionario = context.dataset.label;
                                var porcentagemCpu = context.raw.x;
                                var porcentagemRam = context.raw.y;
                                var qtdProcessos = context.raw.r;
                                return `Nome: ${nomeFuncionario}, CPU: ${porcentagemCpu}%, RAM: ${porcentagemRam}%, Processos: ${qtdProcessos}`;
                            },
                        },
                    },
                },
                scales: {
                    x: {
                        min: 0,
                        max: 100,
                    },
                    y: {
                        min: 0,
                        max: 100,
                    },
                },
            },
        };

        if (myChart) {
            myChart.destroy();
        }

        myChart = new Chart(document.getElementById("myChart"), config);
    }
</script>

</html>
