<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RemoteGuard - Visualize, analise, transforme.</title>
  <link rel="stylesheet" href="../css/dashboard-teste-analista.css">
  <link rel="icon" href="../assets/imgs/logo4-amarela.svg">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
  <header id="main-header">
    <div class="menu-icone" id="menu-icone">
      <img src="../assets/imgs/2.png" alt="Menu" class="menu-img">
    </div>
    <div class="perfil-wrapper">
      <div class="Ativacao">
        <button>Ajuda</button>
      </div>
      <div class="perfil-container">
        <img src="../assets/imgs/a.png" alt="Imagem de Perfil">
        <div class="perfil-text">
          <span class="nome" id="b_usuario">Analista</span>
          <span class="legenda">perfil</span>
        </div>
      </div>
    </div>
  </header>

  <nav id="menuhamburguer">
    <div class="logo">
      <img src="../assets/imgs/logo4-amarela.svg" alt="Logo">
    </div>
    <ul class="menu-items">
      <li class="ativo"><a href="DashAnalista.html"><img src="../assets/imgs/dash.png" alt="Ícone 1">Dashboard</a></li>
      <li class="naoAtivo"><a href="perfilAnalista.html"><img src="../assets/imgs/config.png" alt="Ícone 1">Configuração</a></li>
      <li class="naoAtivo"><a href="../login.html"><img src="../assets/imgs/sair.png" alt="Ícone 1">Sair</a></li>
    </ul>
  </nav>

  <main id="main-Container">
    <div class="controles">
      <select id="recurso">
        <option value="" selected disabled>Selecionar recurso</option>
        <option value="ram">Memória RAM</option>
        <option value="cpu">CPU</option>
        <option value="disco">Disco</option>
      </select>
    <div class="funcionario-atual" id="funcionario-atual">Nome Funcionario do Pc</div>
    </div>
    
    <div class="dashboard">
      <div class="chart-container">
        <div class="mensagem-estilo2" id="mensagemAviso" style="color: red;">Por favor, selecione um recurso para visualizar os dados.</div>
        <div id="chart"></div>
      </div>
      <div class="chart-container2">
      <div id="chartRadar"></div>
      <select class="maquina" id="maquinaComparacao">
        <option value="" selected disabled>Selecionar Máquina para Comparação</option>
        <option value="2">Máquina 2</option>
        <option value="3">Máquina 3</option>
        <option value="4">Máquina 4</option>
      </select>
    </div>
      </div>
      <div class="status-boxes">
        <div class="status-card verde"><span id="funcionario-ativo" class="text-card"></span></div>
        <div class="status-card vermelho"><span id="recurso-alerta" class="text-card"></span></div>
        <div class="status-card amarelo"><span id="processo-mais-utilizado" class="text-card"></span></div>
    </div>
  </main>

  <script>

  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    let grafico;
    var graficoRadar;

    function definirRecurso(recursoSelecionado) {
      const endpoints = {
        ram: { endpoint: "/analista/listarPorcentagemRAM", label: "Memória RAM" },
        cpu: { endpoint: "/analista/listarPorcentagemCPU", label: "CPU" },
        disco: { endpoint: "/analista/listarPorcentagemDisco", label: "Disco" }
      };

      const recurso = endpoints[recursoSelecionado];
      if (!recurso) return;

      document.getElementById('mensagemAviso').style.display = "none";

      if (recursoSelecionado === "disco") {
        buscarDadosDisco(recurso.endpoint);
      } else {
        buscarDadosGrafico(recurso.endpoint, recurso.label);
      }
    }

    function plotarGraficoLinha(dados, labels, label) {
      const options = {
        series: [{
          name: label,
          data: dados,
          color: '#FFD700' 
        }],
        chart: {
          height: 400,
          type: 'line',
          zoom: { enabled: true }
        },
        dataLabels: { enabled: true },
        stroke: {
          curve: 'smooth',
          width: 3
        },
        title: {
          text: `${label} (%)`,
          align: 'left',
          style: { color: '#FFFFFF' }
        },
        grid: {
          row: {
            opacity: 0.5
          }
        },
        xaxis: {
          categories: labels,
          labels: { style: { colors: '#FFFFFF' } },
          title: { text: 'Horário', style: { color: '#FFFFFF' } }
        },
        yaxis: {
          title: { text: 'Porcentagem', style: { color: '#FFFFFF' } },
          labels: { style: { colors: '#FFFFFF' } },
          min: 0, 
          max: 100 
        },
        legend: {
          labels: {
            colors: '#000000', 
            hover: {
              color: '#000000' 
            }
          },
        }
      };
    
      if (grafico) grafico.destroy();
      grafico = new ApexCharts(document.querySelector("#chart"), options);
      grafico.render();
    }
    

    function plotarGraficoDisco(usoDisco) {
      const livreDisco = 100 - usoDisco;

      const options = {
        series: [usoDisco, livreDisco],
        chart: {
          type: 'donut',
          width: '100%',
          height: '350px'
        },
        labels: ['Usado', 'Livre'],
        colors: ['rgba(255,0,0,0.4)', 'rgba(0,128,0,0.4)'],
        title: {
          text: 'Uso de Disco (%)',
          style: { color: '#FFFFFF', fontSize: '18px' }
        },
        legend: {
          labels: {
            colors: '#FFFFFF'
          }
        }
      };

      if (grafico) grafico.destroy();
      grafico = new ApexCharts(document.querySelector("#chart"), options);
      grafico.render();
    }
    
    function buscarDadosGrafico(endpoint, label) {
      fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ idUsuarioServer: sessionStorage.ID_USUARIO, fkNotebook: 1 })
      })
      .then(response => response.json())
      .then(resposta => {
        const dados = [];
        const labels = [];

        resposta.forEach(item => {
          dados.push(label
          === "Memória RAM" ? item.porcentagem_ram : item.porcentagem_cpu);
          labels.push(new Date(item.data_captura).toLocaleTimeString());
        });

        plotarGraficoLinha(dados, labels, label);
      })
      .catch(() => {
        document.getElementById('mensagemAviso').textContent = "Erro ao carregar os dados. Tente novamente mais tarde.";
      });
    }

    function buscarDadosDisco(endpoint) {
      fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ idUsuarioServer: sessionStorage.ID_USUARIO, fkNotebook: 1 })
      })
      .then(response => response.json())
      .then(resposta => {
        const porcentagemDisco = resposta.porcentagem_disco;       
        if (porcentagemDisco !== undefined) {
          plotarGraficoDisco(porcentagemDisco);
        } else {
          document.getElementById('mensagemAviso').textContent = "Nenhum dado de disco encontrado.";
        }
      })
      .catch(error => {
        document.getElementById('mensagemAviso').textContent = "Erro ao carregar os dados. Tente novamente mais tarde.";
      });
    }
    function plotarGraficoRadar(dados) {
      const options = {
        series: [{
          name: 'Máquina Atual',
          color: '#FFEB3B', 
          data: [dados.base.cpu, dados.base.ram, dados.base.disco]
        },
        {
          name: 'Máquina Comparação',
          color: '#00E676',
          data: [dados.comparacao.cpu, dados.comparacao.ram, dados.comparacao.disco],
          backgroundColor: '#FFFFFFFF'
        }],
        chart: {
          height: 350,
          type: 'radar',
          color: '#FFFFFF',
        },
        title: {
          text: 'Comparação de Máquinas',
          style: {
            color: 'white', 
          }
        },
        xaxis: {
          categories: ['CPU', 'RAM', 'Disco'],
          labels: {
            style: {
              colors: 'white', 
            },
          },
        },
        yaxis: {
          labels: {
            style: {
              colors: 'white', 
            },
          },
        },
        legend: {
          position: 'bottom',
          horizontalAlign: 'center',
          labels: {
            style: {
              color: 'white'
            }
          },
          onItemClick: {
            toggleDataSeries: true
          },
          onItemHover: {
            highlightDataSeries: true
          },
          markers: {
            width: 12,
            height: 12
          },
        },
        stroke: {
          show: true, 
          width: 2,
          color: 'transparent', 
        },
        fill: {
          opacity: 0.6, 
        },
        markers: {
          size: 3,
          colors: ['#FFEB3B', '#00E676'], 
          strokeColors: '#FFFFFF',
        },
      };
    
      if (graficoRadar) graficoRadar.destroy();
      graficoRadar = new ApexCharts(document.querySelector("#chartRadar"), options);
      graficoRadar.render();
    
      // Adicionando comportamento de clique na legenda
      document.querySelectorAll('.apexcharts-legend-text').forEach(function(item) {
        item.addEventListener('click', function() {
          item.style.color = 'white';
        });
      });
    
      
      if (graficoRadar) graficoRadar.destroy();
      graficoRadar = new ApexCharts(document.querySelector("#chartRadar"), options);
      graficoRadar.render();
    }
    
    function buscarDadosRadar() {
      const fkNotebookBase = 1; 
      const fkNotebookComparacao = document.getElementById('maquinaComparacao').value;
    
      if (fkNotebookComparacao) {
        fetch("/analista/listarDadosRadar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fkNotebookBase, fkNotebookComparacao })
        })
        .then(response => response.json())
        .then(dados => {
          plotarGraficoRadar(dados);
        })
        .catch(() => {
          alert("Erro ao carregar os dados do gráfico de radar.");
        });
      }
    }
    
    document.getElementById('maquinaComparacao').addEventListener('change', function() {
      buscarDadosRadar();
    });
    
  
    buscarDadosRadar();  

    document.getElementById('recurso').addEventListener('change', (event) => {
      const recursoSelecionado = event.target.value;
      definirRecurso(recursoSelecionado);
    });

    // Manipulação do menu hamburguer
    document.getElementById('menu-icone').addEventListener('click', function () {
      var menuhamburguer = document.getElementById('menuhamburguer');
      var mainContainer = document.getElementById('main-Container');
      var header = document.getElementById('main-header');

      // Alterna a classe 'open' para o menu e a 'menu-open' para o conteúdo e header
      menuhamburguer.classList.toggle('open');
      document.body.classList.toggle('menu-open');
    });
  </script>
</body>
</html>
