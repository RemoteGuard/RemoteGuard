<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - alertas</title>
    <link rel="stylesheet" href="../css/css-dash-Isa.css">
    <link rel="icon" href="../assets/imgs/logo4-amarela.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script
        src="https://cdn.anychart.com/samples/scatter-charts/combination-of-line-and-marker-charts/data.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-ui.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-exports.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/themes/dark_earth.min.js"></script>
    <link href="https://cdn.anychart.com/releases/v8/css/anychart-ui.min.css" type="text/css" rel="stylesheet">
    <link href="https://cdn.anychart.com/releases/v8/fonts/css/anychart-font.min.css" type="text/css" rel="stylesheet">

</head>

<body onload="timeout, buscarEmpresaDoGerenteLogado(), exibirMediaAlertas(), exibirRankingFuncionarios()">
    <header id="main-header">
        <div class="menu-icone" id="menu-icone">
            <img src="../assets/imgs/2.png" alt="Menu" class="menu-img">
        </div>
        <div class="perfil-wrapper">
            <div class="Ativacao">
                <button>Ajuda</button>
            </div>

            <div class="perfil-container">
                <img src="../assets/imgs/a.png" alt="Imagem de Perfil">
                <div class="perfil-text">
                    <span class="nome">Gerente</span>
                    <span class="legenda">perfil</span>
                </div>
            </div>
        </div>
    </header>

    <nav id="menuhamburguer">
        <div class="logo">
            <img src="../assets/imgs/logo4-amarela.svg" alt="Logo">
        </div>
        <ul class="menu-items">
            <li class="ativo"><a href="DashGerente.html"><img src="../assets/imgs/dash.png" alt="Ícone 1">Dashboard</a>
            </li>
            <li class="naoAtivo"><a href=""><img src="../assets/imgs/relatorio.png" alt="Ícone 1">Relatórios</a></li>
            <li class="naoAtivo"><a href="CadastroFunc.html"><img src="../assets/imgs/perfil.png"
                        alt="Ícone 1">Funcionarios</a></li>
            <li class="naoAtivo"><a href="cadastroNote.html"><img src="../assets/imgs/Maquina.png" alt="Ícone 1">
                    Maquinas</a>
            </li>
            <li class="naoAtivo"><a href="perfilGerente.html"><img src="../assets/imgs/config.png"
                        alt="Ícone 1">Configuração</a></li>
            <li class="naoAtivo"><a href="../login.html"><img src="../assets/imgs/sair.png" alt="Ícone 1">Sair</a></li>
        </ul>
    </nav>

    <main id="main-Container">
        <div class="dashboard1">
            <div class="chart-container">
                <div class="ranking">
                    <h1>RANKING - FREQUÊNCIA DE ALERTAS POR FUNCIONÁRIO</h1>
                    <div class="tabelaRanking">
                        <span id="exibirNomesTopFuncionarios"></span>
                        <span id="exibirQtdAlertasTopFuncionarios"></span>
                    </div>
                </div>
                <div class="divider-divs"></div>
                <div class="mediaAlertas">
                    <h1>MÉDIA DE ALERTAS POR FUNCIONÁRIO</h1>
                    <span id="mediaDeAlertas"></span>
                </div>
            </div>
        </div>
        <div class="dashboard2">
            <div id="chart-container2-5" class="chart-container2-5">
            </div>
            <div class="chart-container2">
                <select onchange="buscarNotebookDoFuncionario()" name="select-func" id="selectFunc" class="select-func">
                    <option selected disabled value="#">Selecione um funcionário</option>
                </select>
                <div class="metricas-funcionario">
                    <div id="grafico" class="grafico">
                        <span style="font-size: 16px; display: inline-block; margin-top: 120px; width: 500px; margin-left: -40px; color: red;">É necessário selecionar um funcionário para visualizar estes dados</span>
                    </div>
                    <div id="cards" class="cards" style="display: none;">
                        <div class="card">
                            <h1>TOTAL DE ALERTAS SEMANAIS (hardware)</h1>
                            <span id="totalAlertasHw"></span>
                        </div>
                        <div class="card">
                            <h1>TOTAL DE ALERTAS SEMANAIS (processos)</h1>
                            <span id="totalAlertasProcessos"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </main>
</body>

</html>


<script>
    var requisicaoPadrao = ''
    var empresaGerente = ''
    var fkNote = ''



    // Manipulação do menu hamburguer
    document.getElementById('menu-icone').addEventListener('click', function () {
        var menuhamburguer = document.getElementById('menuhamburguer');
        var mainContainer = document.getElementById('main-Container');
        var header = document.getElementById('main-header');

        // Alterna a classe 'open' para o menu e a 'menu-open' para o conteúdo e header
        menuhamburguer.classList.toggle('open');
        document.body.classList.toggle('menu-open');
    });

    const menuItems = document.querySelectorAll('.menu-items li');

    menuItems.forEach(item => {
        item.addEventListener('click', function () {
            // Remove a classe 'active' de todos os itens
            menuItems.forEach(el => el.classList.remove('active'));
            // Adiciona a classe 'active' ao item clicado
            this.classList.add('active');
        });
    });


    //funcao que traz a fkEmpresa do funcionário que estiver logado
    function buscarEmpresaDoGerenteLogado() {
        idUsuario = sessionStorage.ID_USUARIO

        fetch("/alertas/buscarEmpresaDoGerenteLogado", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                requisicaoPadraoServer: requisicaoPadrao,
                idUsuarioServer: idUsuario
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(json => {
                    json.resultado.forEach(empresa => {
                        empresaGerente = empresa.fkEmpresa
                    });
                });
            } else {
                throw "Erro ao buscar a fkEmpresa do gerente!";
            }
        })
    }

    //função que lista todos os funcionários da fkEmpresa que for encontrada com a função anterior
    var timeout = setTimeout(function listarFuncionarios() {
        fetch("/alertas/listarFuncionarios", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                empresaServer: empresaGerente

            })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(json => {
                    const selectFuncionario = document.getElementById("selectFunc");
                    json.resultado.forEach(funcionario => {
                        const option = document.createElement("option");
                        option.value = funcionario.idFuncionario;
                        option.textContent = funcionario.nome;
                        selectFuncionario.appendChild(option);
                    });
                });
            } else {
                throw "Erro ao listar funcionários!";
            }
        }).catch(function (erro) {
            console.log(`#ERRO: ${erro}`);
        });
    }
        , 500)


    // traz a fkNotebook do funcionário que for selecionado pelo select
    function buscarNotebookDoFuncionario() {
        notebookDoFunc = selectFunc.value

        fetch("/alertas/buscarNotebookDoFuncionario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                fkNotebookServer: notebookDoFunc
            })
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(json => {
                    json.resultado.forEach(funcionario => {
                        fkNote = funcionario.fkNotebook
                    });
                    exibirTotalAlertasHardware()
                    exibirTotalAlertasProcessos()
                    buscarDados()
                    console.log(fkNote)
                });
            } else {
                throw "Erro ao buscar a fk notebook do funcionário selecionado!";
            }
        })
    }

    function exibirTotalAlertasHardware() {
        cards.style.display = 'flex'


        fetch(`/alertas/exibirTotalAlertasHardware/${fkNote}`, {
            method: "GET",
            headers: {
                "Content-Type": 'application\json'
            }
        }).then(function (resposta) {

            console.log("Estou no then do exibirTotalAlertasHardware")

            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    var dados = resposta[0];
                    totalAlertasHw.innerHTML = dados.alertas;
                })
            }
        })
    }

    function exibirTotalAlertasProcessos() {
        fetch(`/alertas/exibirTotalAlertasProcessos/${fkNote}`, {
            method: "GET",
            headers: {
                "Content-Type": 'application\json'
            }
        }).then(function (resposta) {

            console.log("Estou no then do exibirTotalAlertasProcessos")

            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    var dados = resposta[0];
                    totalAlertasProcessos.innerHTML = dados.alertas;
                })
            }
        })
    }

    function exibirMediaAlertas() {
        fetch(`/alertas/exibirMediaAlertas/`, {
            method: "GET",
            headers: {
                "Content-Type": 'application\json'
            }
        }).then(function (resposta) {

            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    var dados = resposta[0];
                    mediaDeAlertas.innerHTML = dados.mediaAlertas;
                })
            }
        })
    }

    function exibirRankingFuncionarios() {
        fetch("/alertas/exibirRankingFuncionarios", {
            method: "GET",
            headers: {
                "Content-Type": 'application\json'
            }
        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    for (var index = 0; index < resposta.length; index++) {
                        var dados = resposta[index];
                        exibirNomesTopFuncionarios.innerHTML += `<div>${dados.nome.toUpperCase()}</div><br>`
                        exibirQtdAlertasTopFuncionarios.innerHTML += ` <div>${dados.qtdAlertas}</div><br>`;

                    }
                })
            }
        })
    }


    function buscarDados() {
        const deletarGrafico = document.getElementById("grafico");
        deletarGrafico.innerHTML = '';

        document.getElementById("grafico").innerHTML += `<div style="width: 100%" id="myChartCanvas" class="canvas"></div>`;

        fetch(`/alertas/buscarDados/${fkNote}`, {
            method: "GET",
            cache: 'no-store',
            headers: {
                "Content-Type": 'application/json'
            }
        }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    plotarGrafico(resposta);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(resposta) {
        let labels = [];
        let data = [];

        for (let i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.DiaSemana);
            data.push(registro.FreqAlertas);
        }

        var options = {
            series: [{
                name: 'Frequência de alertas',
                data: data,
                title: 'Frequência de alertas por dia da semana'
            }],
            chart: {
                type: 'bar',
                height: 300
            },
            plotOptions: {
                bar: {
                    horizontal: false,
                    columnWidth: '55%',
                    endingShape: 'rounded'
                },
            },
            dataLabels: {
                enabled: false
            },
            colors: ['#FFD700'],
            xaxis: {
                categories: labels,
                labels: {
                    style: {
                        colors: '#D3D3D3',
                        fontSize: '11px'
                    }
                },
                axisBorder: {
                    show: true,
                    color: '#D3D3D3'
                },
                axisTicks: {
                    show: true,
                    color: '#D3D3D3'
                }
            },
            yaxis: {
                labels: {
                    style: {
                        colors: '#D3D3D3',
                        fontSize: '12px'
                    }
                },
                title: {
                    text: 'Frequência',
                    style: {
                        color: '#D3D3D3',
                    }
                }
            },
            fill: {
                opacity: 1
            },
            title: {
                text: 'Frequência de alertas por dia da semana',
                align: 'center',
                margin: 10,
                offsetY: 10,
                style: {
                    fontSize: '14px',
                    color: '#D3D3D3'
                }
            },
            tooltip: {
                theme: 'dark',
                style: {
                    fontSize: '14px',
                    color: '#FFFFFF'
                },
                y: {
                    formatter: function (val) {
                        return val + " alertas";
                    }
                }
            },
        };

        var chart = new ApexCharts(document.querySelector("#myChartCanvas"), options);
        chart.render();
    }


    function obterDadosRegressao() {
    return fetch(`/alertas/obterDadosRegressao/`, {
        method: "GET",
        cache: 'no-store',
        headers: {
            "Content-Type": 'application/json'
        }
    }).then(function (response) {
        if (response.ok) {
            return response.json();
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
            return [];
        }
    }).catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        return [];
    });
}

function calcularRegressaoLinear(x, y) {
    const n = x.length;
    const somaX = x.reduce((acc, val) => acc + val, 0);
    const somaY = y.reduce((acc, val) => acc + val, 0);
    const somaXY = x.reduce((acc, val, i) => acc + val * y[i], 0);
    const somaX2 = x.reduce((acc, val) => acc + val * val, 0);

    const m = (n * somaXY - somaX * somaY) / (n * somaX2 - somaX * somaX);
    const b = (somaY - m * somaX) / n;

    return { m, b };
}

anychart.onDocumentReady(function () {
    obterDadosRegressao().then((resposta) => {
        let alertasHW = [];
        let alertasProcessos = [];

        for (let i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            alertasHW.push(registro.alertasHardware);
            alertasProcessos.push(registro.alertasProcessos);
        }

        // Calcular a linha de regressão
        const { m, b } = calcularRegressaoLinear(alertasProcessos, alertasHW);

        // Gerar os pontos da linha de regressão
        const xMin = Math.min(...alertasProcessos);
        const xMax = Math.max(...alertasProcessos);
        const linhaRegressao = [
            { x: 0, value: b }, // Ponto de interceptação no eixo Y
            { x: xMax, value: m * xMax + b }
        ];

        anychart.theme('darkEarth');
        var chart = anychart.scatter();
        chart.animation(true);
        chart.title('Frequência de alertas de hardware em função da frequência de processos indevidos');

        chart.xScale().minimum(0).maximum(xMax + 5).ticks({ interval: 5 });
        chart.yScale().minimum(Math.min(...alertasHW) - 10).maximum(Math.max(...alertasHW) + 10).ticks({ interval: 10 });

        chart.yAxis().title('Frequência - alertas de hardware');
        chart
            .xAxis()
            .title('Frequência - alertas de processos')

        var marker = chart.marker(alertasProcessos.map((x, i) => ({ x: x, value: alertasHW[i] })));
        marker.type('triangle-up').size(4);
        marker
            .hovered()
            .fill('gold')

        var line = chart.line(linhaRegressao);
        line.stroke({ color: '#FFD700', thickness: 2 });

        chart.container('chart-container2-5');
        chart.draw();
    });
});
</script>